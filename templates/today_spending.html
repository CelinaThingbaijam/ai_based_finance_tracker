{% extends 'base.html' %}

{% block title %}Today's Spending{% endblock %}

{% block content %}
<div class="container my-5">
    <h1 class="my-4 text-center">ðŸ’° Today's Spending Overview</h1>

    <!-- Total Spent Section -->
    <div class="d-flex justify-content-between align-items-center mb-4 p-3 rounded shadow-sm" id="total-spent-container">
        <h4 class="my-0 fw-semibold">Total Spent Today:</h4>
        <h4 class="my-0 text-danger fw-bold">â‚¹{{ total_daily_spending|float|round(2) }}</h4>
    </div>

    <div class="row g-4">
        <!-- Category Breakdown -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Category Breakdown</h5>
                    {% if daily_breakdown %}
                    <ul class="list-group list-group-flush">
                        {% for category, amount in daily_breakdown.items() %}
                        <li class="list-group-item d-flex justify-content-between align-items-center">
                            <span class="fw-medium">{{ category }}</span>
                            <span class="badge bg-danger-subtle text-danger rounded-pill">â‚¹{{ amount|float|round(2) }}</span>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="text-center py-3">
                        <p class="text-muted">No spending recorded today.</p>
                        <a href="/add-transaction" class="btn btn-primary btn-sm">Add a Transaction</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Expense Distribution -->
        <div class="col-md-6">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">Expense Distribution</h5>
                    {% if daily_breakdown %}
                    <div class="chart-container">
                        <canvas id="dailyPieChart" aria-label="Daily spending distribution by category"></canvas>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <p class="text-muted">No data to visualize for today.</p>
                        <img src="/static/images/no-data-placeholder.svg" alt="No data placeholder" class="img-fluid" style="max-width: 150px;">
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- All Transactions -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body">
                    <h5 class="card-title">All Transactions</h5>
                    {% if daily_transactions %}
                    <ul class="list-group list-group-flush" id="transactions-list">
                        {% for t in daily_transactions %}
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas fa-{{ 'plus-circle text-success' if t.type == 'income' else 'minus-circle text-danger' }} me-2" aria-hidden="true"></i>
                                    <span>{{ t.category }}</span>
                                </div>
                                <div class="d-flex align-items-center">
                                    <strong class="me-3">â‚¹{{ t.amount|float|round(2) }}</strong>
                                    <button class="btn-delete" data-transaction-id="{{ t.id }}" title="Delete Transaction">
                                        <i class="fas fa-trash" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="text-center py-3">
                        <p class="text-muted">No transactions found for today.</p>
                        <a href="/add-transaction" class="btn btn-primary btn-sm">Add a Transaction</a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // Apply theme from localStorage
    const theme = localStorage.getItem('theme') || 'light';
    const totalSpentContainer = document.getElementById('total-spent-container');
    if (theme === 'dark') {
        document.body.classList.add('dark-theme');
        totalSpentContainer.classList.remove('bg-light');
        totalSpentContainer.classList.add('bg-dark-theme');
    } else {
        totalSpentContainer.classList.add('bg-light');
    }

    // Pie chart configuration
    try {
        const dailyBreakdown = JSON.parse('{{ daily_breakdown | tojson | safe }}');
        const categories = Object.keys(dailyBreakdown);
        const amounts = Object.values(dailyBreakdown);

        // Dynamic color generation
        const colors = [
            '#e74c3c', '#3498db', '#f1c40f', '#2ecc71', '#9b59b6',
            '#e67e22', '#7f8c8d', '#c0392b', '#2980b9', '#27ae60'
        ];
        const dynamicColors = categories.map((_, i) => colors[i % colors.length]);

        if (categories.length > 0) {
            const ctx = document.getElementById('dailyPieChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: categories,
                    datasets: [{
                        data: amounts,
                        backgroundColor: dynamicColors,
                        borderColor: theme === 'dark' ? '#e0e0e0' : '#34495e',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: theme === 'dark' ? '#e0e0e0' : '#333',
                                font: { size: 14 }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => `â‚¹${context.raw.toFixed(2)} (${context.label})`
                            }
                        }
                    }
                }
            });
        }
    } catch (error) {
        console.error('Error initializing chart:', error);
        const chartContainer = document.getElementById('dailyPieChart').parentNode;
        chartContainer.innerHTML = '<p class="text-muted text-center">Unable to load chart. Please try again later.</p>';
    }

    // Delete button event listeners
    document.querySelectorAll('.btn-delete').forEach(button => {
        button.addEventListener('click', async () => {
            const transactionId = button.getAttribute('data-transaction-id');
            if (!transactionId) {
                alert('Error: Transaction ID not found.');
                return;
            }

            if (!confirm('Are you sure you want to delete this transaction?')) {
                return;
            }

            try {
                const response = await fetch(`/delete-transaction/${transactionId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (response.ok) {
                    button.closest('li').remove();
                    // Optionally refresh the page or update totals dynamically
                    alert('Transaction deleted successfully.');
                    window.location.reload(); // Refresh to update totals and chart
                } else {
                    throw new Error('Failed to delete transaction.');
                }
            } catch (error) {
                console.error('Error deleting transaction:', error);
                alert('Error deleting transaction. Please try again.');
            }
        });
    });
});
</script>

<!-- Ensure Font Awesome is included -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
{% endblock %}